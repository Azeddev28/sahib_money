<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="/static/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/static/assets/img/favicon.png">
  <link rel="canonical" href="https://appseed.us/admin-dashboards/django-dashboard-black">

  <title>
    Sahib Money
  </title>

  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,600,700,800" rel="stylesheet" />
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="/static/assets/css/nucleo-icons.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link href="/static/assets/css/black-dashboard.css?v=1.0.0" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="/static/assets/demo/demo.css" rel="stylesheet" />

  <!-- Specific Page CSS goes HERE  -->
  {% block stylesheets %}{% endblock stylesheets %}
  <style>
    span#countdown-timer {
      margin-left: 65%;
      margin-top: 39px !important;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: bold;
      color: white;
  }
     .otp-field {
        display: flex;
        align-items: center;
        width: 100%
     }
     form#otp-form {
      padding-left: 20%;
    }
  </style>
</head>

<body class="">

  <div class="wrapper">

    <div class="main-panel">


      <div class="content">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h4>
                Verify Transaction
              </h4>
            </div>
            <div class="card-body">
              <form id="otp-form" class="form-contact" method="post" data-uuid="{{uuid}}">
                {% csrf_token %}
                    <div class='otp-field'>
                      <label style="color: #fff" class="control-label" for="id_amount">Requested From:</label>
                      <div style="justify-content: center; width: 50%; margin: 15px">
                        <span style="border: 1px solid #fff"class="form-control">{{requested_form}}</span>
                      </div>
                    </div>
                    <div class='otp-field'>
                      <label style="color: #fff" class="control-label" for="id_amount">Amount:</label>
                      <div style="justify-content: center; width: 50%; margin-left: 67px">
                        <span style="border: 1px solid #fff " class="form-control">{{amount}}</span>
                      </div>
                    </div>
                    <div class='otp-field'>
                      <label style="color: #fff; margin-top:19px" class="control-label" for="id_amount">OTP:</label>
                      <div style="justify-content: center; width: 50%; margin-top: 15px; margin-left: 92px">
                        <input style="border: 1px solid #fff" type="text" type="text" class="form-control" name="otp" required="" id="id_otp">
                      </div>
                    </div>
                    <span class="countdown" id='countdown-timer'></span>

                <input type="button" id="submit-otp" disabled onclick="submit_transaction('{{ uuid }}')" style='margin-top:5%' class='btn btn-success btn-xs float-right' value="Submit">

              </form>
            </div>
          </div>
          <div class='row float-right' style='margin-top: -12px'>
            <button disabled class="btn btn-info btn-xs" style='margin-right:10px' id='resent-otp' onclick="resend_otp('{{ uuid }}')">Resend</button>
            <button type="button" class='btn btn-danger btn-xs'
                  onclick="confirmDialog('{{ uuid }}', 'Cancel Transaction', 'Do you want to cancel this transaction?')">Cancel</button>
          </div>

        </div>
      </div>

      {% include 'includes/footer.html' %}

    </div>

  </div>
  <!-- Specific Page JS goes HERE  -->
  {% block javascripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

  <script type="text/javascript">
    var minutes = 0, seconds = 59;
    function startCounter(otp_remaining_seconds){
      var remaining_seconds = (otp_remaining_seconds < 0) ? '01' : otp_remaining_seconds
      var timer2 = "0:" + remaining_seconds;
      console.log(timer2);
      var interval = setInterval(function() {
        var timer = timer2.split(':');
        //by parsing integer, I avoid all extra string processing
        var minutes = parseInt(timer[0], 10);
        var seconds = parseInt(timer[1], 10);
        --seconds;
        minutes = (seconds < 0) ? --minutes : minutes;
        seconds = (seconds < 0) ? 59 : seconds;
        seconds = (seconds < 10) ? '0' + seconds : seconds;
        //minutes = (minutes < 10) ?  minutes : minutes;
        $('.countdown').html(minutes + ':' + seconds);
        //if (minutes < 0) {
          //clearInterval(interval)
          //$('#resent-otp').prop('disabled', false)
        //};
        //check if both minutes and seconds are 0
        if ((seconds <= 0) && (minutes <= 0)) {
          clearInterval(interval)
          $('#resent-otp').prop('disabled', false)
        };
        timer2 = minutes + ':' + seconds;
      }, 1000);
    }
    $(document).ready(function(){
      var otp_remaining_seconds = parseInt('{{otp_remaining_seconds}}');
      startCounter(otp_remaining_seconds)
    })

    $(document).on('input', '#id_otp', function(){
      if($('#id_otp').val() === ''){
        $('#submit-otp').prop('disabled', true)
      }
      else(
        $('#submit-otp').prop('disabled', false)
      )
    })

    function submit_transaction(uuid) {
      $.ajax({
        type: "POST",
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        url: "{% url 'otp_view' uuid %}",
        data: { otp: $("#id_otp").val() },
        success: function (data) {
          window.location.href = data.success_url
        },
        error: function (jqXHR, textStatus, errorThrown) {
          toastr.error("OTP Invalid or Expired!");
        }
      });
    }

    function resend_otp(uuid) {
      $('#resent-otp').prop('disabled', true)
      startCounter(60)
      $.ajax({
        type: "GET",
        url: "{% url 'regenerate_otp' %}",
        data: { "uuid": uuid },
        success: function (data) {
          console.log(data);
        }
      });
    }

    function cancel_transaction(uuid) {
      $.ajax({
        type: "GET",
        url: "{% url 'cancel_withdrawal_transaction' %}",
        data: { "uuid": uuid },
        success: function (data) {
          console.log(data);
        }
      });
    }
    function confirmDialog(uuid, title, message, stay_on_page) {
      $('<div></div>').appendTo('body')
        .html('<div><p style="color: black;">' + message + '</p></div>')
        .dialog({
          modal: true,
          title: title,
          zIndex: 10000,
          autoOpen: true,
          width: 'auto',
          resizable: false,
          buttons: {
            Yes: function () {
              cancel_transaction(uuid)
              window.location.href = "{{company_website}}"
            },
            No: function () {
              $(this).dialog("close");
            }
          },
          close: function (event, ui) {
            $(this).remove();
          }
        });
    };
  </script>
  {% endblock javascripts %}

</body>

</html>
